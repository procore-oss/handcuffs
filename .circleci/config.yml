version: 2.1

jobs:
  test:
    parameters:
      postgresql_version:
        type: string
        default: "14"
      ruby_version:
        type: string
        default: "3.0"
    docker:
      - image: cimg/ruby:<< parameters.ruby_version >>
        environment:
          - PGHOST=localhost
          - PGUSER=ubuntu
          - RAILS_ENV=test
          - BUNDLER_VERSION=2.4.22
      - image: cimg/postgres:<< parameters.postgresql_version >>
        environment:
          POSTGRES_USER: ubuntu
          POSTGRES_DB: handcuffs_test
          POSTGRES_HOST_AUTH_METHOD: trust
    steps:  
      - checkout
      - run:
          name: Install Bundler
          command: gem install bundler:2.4.22
      - run:
          name: Install Ruby Dependencies
          command: bundle install && cd spec/dummy && bundle install
      - run:
          name: Install Apprasals Dependencies
          command: bundle exec appraisal install && cd spec/dummy && bundle exec appraisal install
      - run:
          name: Setup Database
          command: cd spec/dummy && bundle exec rake db:create db:migrate --trace
      - run:
          name: Run Appraisals Tests
          command: bundle exec appraisal rspec
      - run:
          name: Run Dummy App Tests
          command: cd spec/dummy && bundle exec appraisal bin/rspec

workflows:
  version: 2.1
  test-all:
    jobs:
      - test:
          matrix:
            parameters:
              postgresql_version: ['12.17', '13.13', '14.10', '15.5', '16.1']
              ruby_version: ['2.7', '3.0', '3.1', '3.2', '3.3']
